<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
    <meta charset="utf-8">
    <meta name="generator" content="quarto-1.8.23">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


    <title>Analysis 04: Generate Mapping Inputs</title>
    <style>
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      div.columns{display: flex; gap: min(4vw, 1.5em);}
      div.column{flex: auto; overflow-x: auto;}
      div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
      ul.task-list{list-style: none;}
      ul.task-list li input[type="checkbox"] {
        width: 0.8em;
        margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
        vertical-align: middle;
      }
      /* CSS for syntax highlighting */
      html { -webkit-text-size-adjust: 100%; }
      pre > code.sourceCode { white-space: pre; position: relative; }
      pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
      pre > code.sourceCode > span:empty { height: 1.2em; }
      .sourceCode { overflow: visible; }
      code.sourceCode > span { color: inherit; text-decoration: inherit; }
      div.sourceCode { margin: 1em 0; }
      pre.sourceCode { margin: 0; }
      @media screen {
      div.sourceCode { overflow: auto; }
      }
      @media print {
      pre > code.sourceCode { white-space: pre-wrap; }
      pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
      }
      pre.numberSource code
        { counter-reset: source-line 0; }
      pre.numberSource code > span
        { position: relative; left: -4em; counter-increment: source-line; }
      pre.numberSource code > span > a:first-child::before
        { content: counter(source-line);
          position: relative; left: -1em; text-align: right; vertical-align: baseline;
          border: none; display: inline-block;
          -webkit-touch-callout: none; -webkit-user-select: none;
          -khtml-user-select: none; -moz-user-select: none;
          -ms-user-select: none; user-select: none;
          padding: 0 4px; width: 4em;
        }
      pre.numberSource { margin-left: 3em;  padding-left: 4px; }
      div.sourceCode
        {   }
      @media screen {
      pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
      }
    </style>

    <style>
      body.hypothesis-enabled #quarto-embed-header {
        padding-right: 36px;
      }

      #quarto-embed-header {
        height: 3em;
        width: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: solid 1px;
      }

      #quarto-embed-header h6 {
        font-size: 1.1em;
        padding-top: 0.6em;
        margin-left: 1em;
        margin-right: 1em;
        font-weight: 400;
      }

      #quarto-embed-header a.quarto-back-link,
      #quarto-embed-header a.quarto-download-embed {
        font-size: 0.8em;
        margin-top: 1em;
        margin-bottom: 1em;
        margin-left: 1em;
        margin-right: 1em;
      }

      .quarto-back-container {
        padding-left: 0.5em;
        display: flex;
      }

      .headroom {
          will-change: transform;
          transition: transform 200ms linear;
      }

      .headroom--pinned {
          transform: translateY(0%);
      }

      .headroom--unpinned {
          transform: translateY(-100%);
      }      
    </style>

    <script>
    window.document.addEventListener("DOMContentLoaded", function () {

      var header = window.document.querySelector("#quarto-embed-header");
      const titleBannerEl = window.document.querySelector("body > #title-block-header");
      if (titleBannerEl) {
        titleBannerEl.style.paddingTop = header.clientHeight + "px";
      }
      const contentEl = window.document.getElementById('quarto-content');
      for (const child of contentEl.children) {
        child.style.paddingTop = header.clientHeight + "px";
        child.style.marginTop = "1em";
      }

      // Use the article root if the `back` call doesn't work. This isn't perfect
      // but should typically work
      window.quartoBackToArticle = () => {
        var currentUrl = window.location.href;
        window.history.back();
        setTimeout(() => {
            // if location was not changed in 100 ms, then there is no history back
            if(currentUrl === window.location.href){              
                // redirect to site root
                window.location.href = "../index.html";
            }
        }, 100);
      }

      const headroom = new window.Headroom(header, {
        tolerance: 5,
        onPin: function () {
        },
        onUnpin: function () {
        },
      });
      headroom.init();
    });
    </script>

    
<script src="../site_libs/manuscript-notebook/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-1fe81d0376b2c50856e68e651e390326.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-a74871fe4945b66d259aafc266475145.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
     
      </head>

  <body class="quarto-notebook quarto-light">
    <div id="quarto-embed-header" class="headroom fixed-top bg-primary">
      
      <a onclick="window.quartoBackToArticle(); return false;" class="btn btn-primary quarto-back-link" href=""><i class="bi bi-caret-left"></i> Back to Article</a>
      <h6><i class="bi bi-journal-code"></i> Analysis 04: Generate Mapping Inputs</h6>

            <a href="../analysis/trait_generate_mapping_inputs.qmd" class="btn btn-primary quarto-download-embed" download="trait_generate_mapping_inputs.qmd">Download Source</a>
          </div>

     <header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Analysis 04: Generate Mapping Inputs</h1>
          </div>

    
    <div class="quarto-title-meta-container">
      <div class="quarto-title-meta-column-start">
        
        <div class="quarto-title-meta">

                
          
                
              </div>
      </div>
      <div class="quarto-title-meta-column-end quarto-other-formats-target">
      </div>
    </div>



    <div class="quarto-other-links-text-target">
    </div>  </div>
</header><div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup">Setup</a></li>
  <li><a href="#overview" id="toc-overview" class="nav-link" data-scroll-target="#overview">Overview</a></li>
  <li><a href="#inputs" id="toc-inputs" class="nav-link" data-scroll-target="#inputs">Inputs</a></li>
  <li><a href="#load-cleaned-data" id="toc-load-cleaned-data" class="nav-link" data-scroll-target="#load-cleaned-data">Load cleaned data</a></li>
  <li><a href="#aggregate-trait-data" id="toc-aggregate-trait-data" class="nav-link" data-scroll-target="#aggregate-trait-data">Aggregate trait data</a></li>
  <li><a href="#generate-pheno.df.rda-file" id="toc-generate-pheno.df.rda-file" class="nav-link" data-scroll-target="#generate-pheno.df.rda-file">Generate pheno.df.rda file</a>
  <ul class="collapse">
  <li><a href="#download-cleaned-.rdata-file" id="toc-download-cleaned-.rdata-file" class="nav-link" data-scroll-target="#download-cleaned-.rdata-file">Download cleaned .Rdata file</a></li>
  <li><a href="#process-phenotype-data" id="toc-process-phenotype-data" class="nav-link" data-scroll-target="#process-phenotype-data">Process phenotype data</a></li>
  <li><a href="#save-pheno.df.rda" id="toc-save-pheno.df.rda" class="nav-link" data-scroll-target="#save-pheno.df.rda">Save pheno.df.rda</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content quarto-banner-title-block" id="quarto-document-content">      

       <section id="setup" class="level1">
<h1>Setup</h1>
<div class="cell-container"><div class="cell-decorator"><pre>In [1]:</pre></div><div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'dplyr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:data.table':

    between, first, last</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:stats':

    filter, lag</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:base':

    intersect, setdiff, setequal, union</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'purrr'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:data.table':

    transpose</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(httr)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(glue)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="fu">source</span>(<span class="st">"bin/outs.R"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'kableExtra'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:dplyr':

    group_rows</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>
Attaching package: 'flextable'</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following objects are masked from 'package:kableExtra':

    as_image, footnote</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>The following object is masked from 'package:purrr':

    compose</code></pre>
</div>
</div></div>
</section>
<section id="overview" class="level1">
<h1>Overview</h1>
<p>The cleaned phenotype data is stored in the data cleaning <a href="'https://github.com/AndersenLab/2021_GWA_data_cleaning/tree/main/data/processed'">Github repo</a>. From the cleaned data, we generate mapping inputs for NemaScan.</p>
<p>This script will pull the trait files from the data cleaning repo for the toxicants analyzed in this study, and format them for NemaScan.</p>
<p>The input format is a file where the rownames represent strain names, and the columns represent the traits to be mapped. The first column is the strain names, and the subsequent columns are the trait values.</p>
</section>
<section id="inputs" class="level1">
<h1>Inputs</h1>
<div class="cell-container"><div class="cell-decorator"><pre>In [2]:</pre></div><div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Path to toxicant metadata file (generated by organize_tox_metadata.qmd)</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>con_metadata_fn <span class="ot">&lt;-</span> <span class="st">"data/processed/tox_data/con_metadata.csv"</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co"># GitHub repo details for downloading trait files</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>github_repo <span class="ot">&lt;-</span> <span class="st">"AndersenLab/2021_GWA_data_cleaning"</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>github_branch <span class="ot">&lt;-</span> <span class="st">"main"</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>github_traitfiles_path <span class="ot">&lt;-</span> <span class="st">"data/processed/traitfiles"</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Expected date prefix in trait file names</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>date_prefix <span class="ot">&lt;-</span> <span class="st">"20230322"</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Output path for generated trait file</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>output_fn <span class="ot">&lt;-</span> <span class="st">"data/processed/aggregated_toxicant_traits.tsv"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div></div>
</section>
<section id="load-cleaned-data" class="level1">
<h1>Load cleaned data</h1>
<p>Download the cleaned data stored in the <code>traitfiles</code> folder of the data cleaning repo. The trait files are named according to the following convention: <code>&lt;date&gt;_&lt;trait_name&gt;_traitfile.tsv</code>, (e.g., <code>20230322_2_4_D_traitfile.tsv</code>, or <code>20230322_Aldicarb_traitfile.tsv</code>). Each file has three columns: <code>strain</code>, <code>&lt;trait&gt;_length</code>, <code>&lt;trait_CV_length&gt;</code>.</p>
<p>The folder also contains other data collected for other chemicals not included here. So we filter to just the files that have the toxicant data.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [3]:</pre></div><div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Load condition metadata to identify which toxicants to download</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>con_metadata <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(con_metadata_fn)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract unique trait names, removing the "length_" prefix to get file name component</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>trait_info <span class="ot">&lt;-</span> con_metadata <span class="sc">%&gt;%</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(trait, toxicant) <span class="sc">%&gt;%</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">distinct</span>() <span class="sc">%&gt;%</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove "length_" prefix to get the trait name used in filenames</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">trait_filename =</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(trait, <span class="st">"^length_"</span>, <span class="st">""</span>),</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fix decimal point issues: convert underscore before decimal numbers back to period</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># e.g., "Paraquat_62_5" -&gt; "Paraquat_62.5"</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This handles cases like: Paraquat_62.5, Silver_nitrate_7.8, Triphenyl_phosphate_6.25</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">trait_filename =</span> stringr<span class="sc">::</span><span class="fu">str_replace</span>(trait_filename, <span class="st">"_(</span><span class="sc">\\</span><span class="st">d+)_(</span><span class="sc">\\</span><span class="st">d+)$"</span>, <span class="st">"_</span><span class="sc">\\</span><span class="st">1.</span><span class="sc">\\</span><span class="st">2"</span>),</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Construct expected filename</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">filename =</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"{date_prefix}_{trait_filename}_traitfile.tsv"</span>)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Found {nrow(trait_info)} toxicant traits to download"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Found 26 toxicant traits to download</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(trait_info)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>                              trait                 toxicant
                             &lt;char&gt;                   &lt;char&gt;
 1:                    length_2_4_D                    2,4-D
 2:                 length_Aldicarb                 Aldicarb
 3:         length_Arsenic_trioxide                  Arsenic
 4:                 length_Atrazine                 Atrazine
 5:       length_Cadmium_dichloride       Cadmium dichloride
 6:                 length_Carbaryl                 Carbaryl
 7:                 length_Carboxin                 Carboxin
 8:             length_Chlorfenapyr             Chlorfenapyr
 9:           length_Chlorothalonil           Chlorothalonil
10:             length_Chlorpyrifos             Chlorpyrifos
11:          length_Copper_chloride          Copper chloride
12:             length_Lead_nitrate        Lead (II) nitrate
13:                length_Malathion                Malathion
14:                 length_Mancozeb                 Mancozeb
15:                 length_Methomyl                 Methomyl
16:           length_Methyl_mercury Methylmercury dichloride
17:        length_Nickel_dichloride        Nickel dichloride
18:            length_Paraquat_62_5                 Paraquat
19:             length_Paraquat_250                 Paraquat
20:                 length_Propoxur                 Propoxur
21:           length_Pyraclostrobin           Pyraclostrobin
22:       length_Silver_nitrate_250           Silver nitrate
23:       length_Silver_nitrate_7_8           Silver nitrate
24: length_Triphenyl_phosphate_6_25      Triphenyl phosphate
25:   length_Triphenyl_phosphate_50      Triphenyl phosphate
26:          length_Zinc_dichloride          Zinc dichloride
                              trait                 toxicant
              trait_filename                                        filename
                      &lt;char&gt;                                          &lt;glue&gt;
 1:                    2_4_D                    20230322_2_4_D_traitfile.tsv
 2:                 Aldicarb                 20230322_Aldicarb_traitfile.tsv
 3:         Arsenic_trioxide         20230322_Arsenic_trioxide_traitfile.tsv
 4:                 Atrazine                 20230322_Atrazine_traitfile.tsv
 5:       Cadmium_dichloride       20230322_Cadmium_dichloride_traitfile.tsv
 6:                 Carbaryl                 20230322_Carbaryl_traitfile.tsv
 7:                 Carboxin                 20230322_Carboxin_traitfile.tsv
 8:             Chlorfenapyr             20230322_Chlorfenapyr_traitfile.tsv
 9:           Chlorothalonil           20230322_Chlorothalonil_traitfile.tsv
10:             Chlorpyrifos             20230322_Chlorpyrifos_traitfile.tsv
11:          Copper_chloride          20230322_Copper_chloride_traitfile.tsv
12:             Lead_nitrate             20230322_Lead_nitrate_traitfile.tsv
13:                Malathion                20230322_Malathion_traitfile.tsv
14:                 Mancozeb                 20230322_Mancozeb_traitfile.tsv
15:                 Methomyl                 20230322_Methomyl_traitfile.tsv
16:           Methyl_mercury           20230322_Methyl_mercury_traitfile.tsv
17:        Nickel_dichloride        20230322_Nickel_dichloride_traitfile.tsv
18:            Paraquat_62.5            20230322_Paraquat_62.5_traitfile.tsv
19:             Paraquat_250             20230322_Paraquat_250_traitfile.tsv
20:                 Propoxur                 20230322_Propoxur_traitfile.tsv
21:           Pyraclostrobin           20230322_Pyraclostrobin_traitfile.tsv
22:       Silver_nitrate_250       20230322_Silver_nitrate_250_traitfile.tsv
23:       Silver_nitrate_7.8       20230322_Silver_nitrate_7.8_traitfile.tsv
24: Triphenyl_phosphate_6.25 20230322_Triphenyl_phosphate_6.25_traitfile.tsv
25:   Triphenyl_phosphate_50   20230322_Triphenyl_phosphate_50_traitfile.tsv
26:          Zinc_dichloride          20230322_Zinc_dichloride_traitfile.tsv
              trait_filename                                        filename</code></pre>
</div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [4]:</pre></div><div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to download a single trait file from GitHub</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>download_trait_file <span class="ot">&lt;-</span> <span class="cf">function</span>(filename, <span class="at">repo =</span> github_repo, <span class="at">branch =</span> github_branch,</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                                <span class="at">path =</span> github_traitfiles_path) {</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Construct raw GitHub URL</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  raw_url <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"https://raw.githubusercontent.com/{repo}/{branch}/{path}/{filename}"</span>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Downloading: {filename}"</span>))</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Download file - httr handles authentication via .Renviron or system credentials</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  response <span class="ot">&lt;-</span> httr<span class="sc">::</span><span class="fu">GET</span>(raw_url)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Check if download was successful</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (httr<span class="sc">::</span><span class="fu">status_code</span>(response) <span class="sc">==</span> <span class="dv">200</span>) {</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parse content as text and read as data.table</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>    content_text <span class="ot">&lt;-</span> httr<span class="sc">::</span><span class="fu">content</span>(response, <span class="st">"text"</span>, <span class="at">encoding =</span> <span class="st">"UTF-8"</span>)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>    df <span class="ot">&lt;-</span> data.table<span class="sc">::</span><span class="fu">fread</span>(<span class="at">text =</span> content_text)</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"  ✓ Successfully downloaded {filename} ({nrow(df)} strains)"</span>))</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(df)</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"  ✗ Failed to download {filename}: HTTP {httr::status_code(response)}"</span>))</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Download all trait files</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>trait_files_list <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">map</span>(trait_info<span class="sc">$</span>filename, download_trait_file)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: 20230322_2_4_D_traitfile.tsv</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  ✓ Successfully downloaded 20230322_2_4_D_traitfile.tsv (192 strains)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: 20230322_Aldicarb_traitfile.tsv</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  ✓ Successfully downloaded 20230322_Aldicarb_traitfile.tsv (194 strains)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: 20230322_Arsenic_trioxide_traitfile.tsv</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  ✓ Successfully downloaded 20230322_Arsenic_trioxide_traitfile.tsv (194 strains)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: 20230322_Atrazine_traitfile.tsv</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  ✓ Successfully downloaded 20230322_Atrazine_traitfile.tsv (195 strains)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: 20230322_Cadmium_dichloride_traitfile.tsv</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  ✓ Successfully downloaded 20230322_Cadmium_dichloride_traitfile.tsv (190 strains)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: 20230322_Carbaryl_traitfile.tsv</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  ✓ Successfully downloaded 20230322_Carbaryl_traitfile.tsv (194 strains)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: 20230322_Carboxin_traitfile.tsv</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  ✓ Successfully downloaded 20230322_Carboxin_traitfile.tsv (193 strains)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: 20230322_Chlorfenapyr_traitfile.tsv</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  ✓ Successfully downloaded 20230322_Chlorfenapyr_traitfile.tsv (152 strains)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: 20230322_Chlorothalonil_traitfile.tsv</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  ✓ Successfully downloaded 20230322_Chlorothalonil_traitfile.tsv (194 strains)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: 20230322_Chlorpyrifos_traitfile.tsv</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  ✓ Successfully downloaded 20230322_Chlorpyrifos_traitfile.tsv (173 strains)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: 20230322_Copper_chloride_traitfile.tsv</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  ✓ Successfully downloaded 20230322_Copper_chloride_traitfile.tsv (194 strains)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: 20230322_Lead_nitrate_traitfile.tsv</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  ✓ Successfully downloaded 20230322_Lead_nitrate_traitfile.tsv (194 strains)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: 20230322_Malathion_traitfile.tsv</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  ✓ Successfully downloaded 20230322_Malathion_traitfile.tsv (194 strains)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: 20230322_Mancozeb_traitfile.tsv</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  ✓ Successfully downloaded 20230322_Mancozeb_traitfile.tsv (194 strains)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: 20230322_Methomyl_traitfile.tsv</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  ✓ Successfully downloaded 20230322_Methomyl_traitfile.tsv (143 strains)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: 20230322_Methyl_mercury_traitfile.tsv</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  ✓ Successfully downloaded 20230322_Methyl_mercury_traitfile.tsv (193 strains)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: 20230322_Nickel_dichloride_traitfile.tsv</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  ✓ Successfully downloaded 20230322_Nickel_dichloride_traitfile.tsv (193 strains)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: 20230322_Paraquat_62.5_traitfile.tsv</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  ✓ Successfully downloaded 20230322_Paraquat_62.5_traitfile.tsv (155 strains)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: 20230322_Paraquat_250_traitfile.tsv</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  ✓ Successfully downloaded 20230322_Paraquat_250_traitfile.tsv (192 strains)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: 20230322_Propoxur_traitfile.tsv</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  ✓ Successfully downloaded 20230322_Propoxur_traitfile.tsv (194 strains)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: 20230322_Pyraclostrobin_traitfile.tsv</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  ✓ Successfully downloaded 20230322_Pyraclostrobin_traitfile.tsv (194 strains)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: 20230322_Silver_nitrate_250_traitfile.tsv</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  ✓ Successfully downloaded 20230322_Silver_nitrate_250_traitfile.tsv (186 strains)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: 20230322_Silver_nitrate_7.8_traitfile.tsv</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  ✓ Successfully downloaded 20230322_Silver_nitrate_7.8_traitfile.tsv (194 strains)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: 20230322_Triphenyl_phosphate_6.25_traitfile.tsv</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  ✓ Successfully downloaded 20230322_Triphenyl_phosphate_6.25_traitfile.tsv (175 strains)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: 20230322_Triphenyl_phosphate_50_traitfile.tsv</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  ✓ Successfully downloaded 20230322_Triphenyl_phosphate_50_traitfile.tsv (191 strains)</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: 20230322_Zinc_dichloride_traitfile.tsv</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  ✓ Successfully downloaded 20230322_Zinc_dichloride_traitfile.tsv (174 strains)</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Name the list elements with the trait names for easy reference</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(trait_files_list) <span class="ot">&lt;-</span> trait_info<span class="sc">$</span>trait</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove any NULL entries (failed downloads)</span></span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>trait_files_list <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">compact</span>(trait_files_list)</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Successfully downloaded {length(trait_files_list)} out of {nrow(trait_info)} trait files"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Successfully downloaded 26 out of 26 trait files</code></pre>
</div>
</div></div>
</section>
<section id="aggregate-trait-data" class="level1">
<h1>Aggregate trait data</h1>
<p>Extract only the <code>&lt;trait&gt;_length</code> columns from each file and combine into a single wide-format dataframe where strains are rows and traits are columns.</p>
<div class="cell-container"><div class="cell-decorator"><pre>In [5]:</pre></div><div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb75"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to extract and rename the length column from a trait file</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>process_trait_file <span class="ot">&lt;-</span> <span class="cf">function</span>(df, trait_name) {</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Identify the length column (should match pattern: &lt;something&gt;_length but not CV_length)</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>  length_col <span class="ot">&lt;-</span> <span class="fu">names</span>(df)[stringr<span class="sc">::</span><span class="fu">str_detect</span>(<span class="fu">names</span>(df), <span class="st">"_length$"</span>) <span class="sc">&amp;</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span>stringr<span class="sc">::</span><span class="fu">str_detect</span>(<span class="fu">names</span>(df), <span class="st">"^CV_"</span>)]</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(length_col) <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"No length column found for trait: {trait_name}"</span>))</span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(<span class="cn">NULL</span>)</span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(length_col) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">warning</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Multiple length columns found for trait: {trait_name}, using first"</span>))</span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>    length_col <span class="ot">&lt;-</span> length_col[<span class="dv">1</span>]</span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Select strain and length column, rename length column to match trait name</span></span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Note: trait_name should already have the "length_" prefix and underscores instead of periods</span></span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(strain, <span class="sc">!!</span><span class="fu">sym</span>(length_col)) <span class="sc">%&gt;%</span></span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="sc">!!</span><span class="at">trait_name :=</span> <span class="sc">!!</span><span class="fu">sym</span>(length_col))</span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Process each trait file</span></span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a>processed_traits <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">imap</span>(trait_files_list, <span class="sc">~</span> <span class="fu">process_trait_file</span>(.x, .y))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in process_trait_file(.x, .y): Multiple length columns found for trait:
length_2_4_D, using first</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in process_trait_file(.x, .y): Multiple length columns found for trait:
length_Aldicarb, using first</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in process_trait_file(.x, .y): Multiple length columns found for trait:
length_Arsenic_trioxide, using first</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in process_trait_file(.x, .y): Multiple length columns found for trait:
length_Atrazine, using first</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in process_trait_file(.x, .y): Multiple length columns found for trait:
length_Cadmium_dichloride, using first</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in process_trait_file(.x, .y): Multiple length columns found for trait:
length_Carbaryl, using first</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in process_trait_file(.x, .y): Multiple length columns found for trait:
length_Carboxin, using first</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in process_trait_file(.x, .y): Multiple length columns found for trait:
length_Chlorfenapyr, using first</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in process_trait_file(.x, .y): Multiple length columns found for trait:
length_Chlorothalonil, using first</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in process_trait_file(.x, .y): Multiple length columns found for trait:
length_Chlorpyrifos, using first</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in process_trait_file(.x, .y): Multiple length columns found for trait:
length_Copper_chloride, using first</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in process_trait_file(.x, .y): Multiple length columns found for trait:
length_Lead_nitrate, using first</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in process_trait_file(.x, .y): Multiple length columns found for trait:
length_Malathion, using first</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in process_trait_file(.x, .y): Multiple length columns found for trait:
length_Mancozeb, using first</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in process_trait_file(.x, .y): Multiple length columns found for trait:
length_Methomyl, using first</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in process_trait_file(.x, .y): Multiple length columns found for trait:
length_Methyl_mercury, using first</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in process_trait_file(.x, .y): Multiple length columns found for trait:
length_Nickel_dichloride, using first</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in process_trait_file(.x, .y): Multiple length columns found for trait:
length_Paraquat_62_5, using first</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in process_trait_file(.x, .y): Multiple length columns found for trait:
length_Paraquat_250, using first</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in process_trait_file(.x, .y): Multiple length columns found for trait:
length_Propoxur, using first</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in process_trait_file(.x, .y): Multiple length columns found for trait:
length_Pyraclostrobin, using first</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in process_trait_file(.x, .y): Multiple length columns found for trait:
length_Silver_nitrate_250, using first</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in process_trait_file(.x, .y): Multiple length columns found for trait:
length_Silver_nitrate_7_8, using first</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in process_trait_file(.x, .y): Multiple length columns found for trait:
length_Triphenyl_phosphate_6_25, using first</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in process_trait_file(.x, .y): Multiple length columns found for trait:
length_Triphenyl_phosphate_50, using first</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in process_trait_file(.x, .y): Multiple length columns found for trait:
length_Zinc_dichloride, using first</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove any NULL entries</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>processed_traits <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">compact</span>(processed_traits)</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge all trait dataframes by strain</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Start with the first dataframe</span></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a>aggregated_traits <span class="ot">&lt;-</span> processed_traits[[<span class="dv">1</span>]]</span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Iteratively left join the remaining dataframes</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(processed_traits) <span class="sc">&gt;</span> <span class="dv">1</span>) {</span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">2</span><span class="sc">:</span><span class="fu">length</span>(processed_traits)) {</span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>    aggregated_traits <span class="ot">&lt;-</span> aggregated_traits <span class="sc">%&gt;%</span></span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a>      dplyr<span class="sc">::</span><span class="fu">full_join</span>(processed_traits[[i]], <span class="at">by =</span> <span class="st">"strain"</span>)</span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Aggregated traits data:"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Aggregated traits data:</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"  Strains: {nrow(aggregated_traits)}"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Strains: 195</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb106"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"  Traits: {ncol(aggregated_traits) - 1}"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Traits: 26</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb108"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"  Columns: {paste(names(aggregated_traits), collapse = ', ')}"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Columns: strain, length_2_4_D, length_Aldicarb, length_Arsenic_trioxide, length_Atrazine, length_Cadmium_dichloride, length_Carbaryl, length_Carboxin, length_Chlorfenapyr, length_Chlorothalonil, length_Chlorpyrifos, length_Copper_chloride, length_Lead_nitrate, length_Malathion, length_Mancozeb, length_Methomyl, length_Methyl_mercury, length_Nickel_dichloride, length_Paraquat_62_5, length_Paraquat_250, length_Propoxur, length_Pyraclostrobin, length_Silver_nitrate_250, length_Silver_nitrate_7_8, length_Triphenyl_phosphate_6_25, length_Triphenyl_phosphate_50, length_Zinc_dichloride</code></pre>
</div>
</div></div>
<div class="cell-container"><div class="cell-decorator"><pre>In [6]:</pre></div><div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the aggregated trait file</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="fu">save_tsv</span>(</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">data =</span> aggregated_traits,</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">output_file =</span> output_fn</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Saved aggregated traits to: {output_fn}"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Saved aggregated traits to: data/processed/aggregated_toxicant_traits.tsv</code></pre>
</div>
</div></div>
</section>
<section id="generate-pheno.df.rda-file" class="level1">
<h1>Generate pheno.df.rda file</h1>
<p>The <code>pheno.df.rda</code> file contains the full phenotype data for all wells and is used in various downstream analyses. This section downloads the cleaned data from the data cleaning GitHub repository and filters it to include only toxicant conditions (excluding controls).</p>
<section id="download-cleaned-.rdata-file" class="level2">
<h2 class="anchored" data-anchor-id="download-cleaned-.rdata-file">Download cleaned .Rdata file</h2>
<div class="cell-container"><div class="cell-decorator"><pre>In [7]:</pre></div><div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Define paths</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>rdata_url <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"https://raw.githubusercontent.com/{github_repo}/{github_branch}/data/processed/{date_prefix}_FINAL_cleaned_GWA.Rdata"</span>)</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>rdata_local_path <span class="ot">&lt;-</span> glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"data/raw/{date_prefix}_FINAL_cleaned_GWA.Rdata"</span>)</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>pheno_df_output <span class="ot">&lt;-</span> <span class="st">"data/processed/phenotypes/pheno.df.rda"</span></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Download .Rdata file if it doesn't exist locally</span></span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(rdata_local_path)) {</span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Downloading {date_prefix}_FINAL_cleaned_GWA.Rdata from GitHub..."</span>))</span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>  response <span class="ot">&lt;-</span> httr<span class="sc">::</span><span class="fu">GET</span>(rdata_url)</span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (httr<span class="sc">::</span><span class="fu">status_code</span>(response) <span class="sc">==</span> <span class="dv">200</span>) {</span>
<span id="cb112-14"><a href="#cb112-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Write binary content to file</span></span>
<span id="cb112-15"><a href="#cb112-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">writeBin</span>(httr<span class="sc">::</span><span class="fu">content</span>(response, <span class="st">"raw"</span>), rdata_local_path)</span>
<span id="cb112-16"><a href="#cb112-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">message</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"  ✓ Successfully downloaded to {rdata_local_path}"</span>))</span>
<span id="cb112-17"><a href="#cb112-17" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb112-18"><a href="#cb112-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">stop</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"  ✗ Failed to download .Rdata file: HTTP {httr::status_code(response)}"</span>))</span>
<span id="cb112-19"><a href="#cb112-19" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb112-20"><a href="#cb112-20" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb112-21"><a href="#cb112-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Using existing file: {rdata_local_path}"</span>))</span>
<span id="cb112-22"><a href="#cb112-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Using existing file: data/raw/20230322_FINAL_cleaned_GWA.Rdata</code></pre>
</div>
</div></div>
</section>
<section id="process-phenotype-data" class="level2">
<h2 class="anchored" data-anchor-id="process-phenotype-data">Process phenotype data</h2>
<div class="cell-container"><div class="cell-decorator"><pre>In [8]:</pre></div><div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the .Rdata file</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(<span class="st">"Loading cleaned GWA data..."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loading cleaned GWA data...</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb116"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a><span class="fu">load</span>(rdata_local_path)</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Check that the expected object exists</span></span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"final.QC.GWA.df"</span>)) {</span>
<span id="cb116-6"><a href="#cb116-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stop</span>(<span class="st">"Expected object 'final.QC.GWA.df' not found in .Rdata file"</span>)</span>
<span id="cb116-7"><a href="#cb116-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb116-8"><a href="#cb116-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb116-9"><a href="#cb116-9" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Loaded data with {nrow(final.QC.GWA.df)} rows"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Loaded data with 108258 rows</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Get list of toxicants from metadata (exclude controls)</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a><span class="co"># The new con_metadata only contains toxicants, so we can use it directly</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>tox_list <span class="ot">&lt;-</span> con_metadata <span class="sc">%&gt;%</span></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(type <span class="sc">==</span> <span class="st">"Toxicant"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">pull</span>(drug) <span class="sc">%&gt;%</span></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Filtering to {length(tox_list)} toxicants"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Filtering to 26 toxicants</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Process the phenotype data</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Join with toxicant metadata and filter to only include toxicants</span></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>pheno.df <span class="ot">&lt;-</span> final.QC.GWA.df <span class="sc">%&gt;%</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(drug <span class="sc">%in%</span> tox_list) <span class="sc">%&gt;%</span></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create well.id from Assay_Bleach, Metadata_Plate, and Metadata_Well</span></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">well.id =</span> <span class="fu">paste</span>(Assay_Bleach, Metadata_Plate, Metadata_Well, <span class="at">sep =</span> <span class="st">"_"</span>),</span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Replace PD1074 strain name with N2</span></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">strain =</span> <span class="fu">ifelse</span>(strain <span class="sc">==</span> <span class="st">"PD1074"</span>, <span class="st">"N2"</span>, strain)</span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Processed phenotype data:"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Processed phenotype data:</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"  Rows: {nrow(pheno.df)}"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>  Rows: 53302</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"  Strains: {length(unique(pheno.df$strain))}"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>  Strains: 195</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"  Drugs: {length(unique(pheno.df$drug))}"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>  Drugs: 26</code></pre>
</div>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"  Columns: {ncol(pheno.df)}"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>  Columns: 50</code></pre>
</div>
</div></div>
</section>
<section id="save-pheno.df.rda" class="level2">
<h2 class="anchored" data-anchor-id="save-pheno.df.rda">Save pheno.df.rda</h2>
<div class="cell-container"><div class="cell-decorator"><pre>In [9]:</pre></div><div class="cell">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb130"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Create output directory if it doesn't exist</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>output_dir <span class="ot">&lt;-</span> <span class="fu">dirname</span>(pheno_df_output)</span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(output_dir)) {</span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dir.create</span>(output_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">message</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Created directory: {output_dir}"</span>))</span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the pheno.df object</span></span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(pheno.df, <span class="at">file =</span> pheno_df_output)</span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a><span class="fu">message</span>(glue<span class="sc">::</span><span class="fu">glue</span>(<span class="st">"Saved pheno.df to: {pheno_df_output}"</span>))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stderr">
<pre><code>Saved pheno.df to: data/processed/phenotypes/pheno.df.rda</code></pre>
</div>
</div></div>
<!-- ## Compare with existing file -->
<!-- ```{r}
#| label: compare-versions

# Load the old version for comparison
old_pheno_path <- "data/raw/phenotypes/pheno.df.rda"

if (file.exists(old_pheno_path)) {
  message("\nComparing new version with existing file...")

  # Load old version
  load(old_pheno_path)
  old_pheno.df <- pheno.df

  # Load new version
  load(pheno_df_output)
  new_pheno.df <- pheno.df

  # Compare dimensions
  message(glue::glue("Old version: {nrow(old_pheno.df)} rows × {ncol(old_pheno.df)} columns"))
  message(glue::glue("New version: {nrow(new_pheno.df)} rows × {ncol(new_pheno.df)} columns"))

  # Compare columns
  old_cols <- colnames(old_pheno.df)
  new_cols <- colnames(new_pheno.df)

  missing_cols <- setdiff(old_cols, new_cols)
  extra_cols <- setdiff(new_cols, old_cols)

  if (length(missing_cols) > 0) {
    message(glue::glue("\nColumns in old but not in new: {paste(missing_cols, collapse=', ')}"))
  }

  if (length(extra_cols) > 0) {
    message(glue::glue("\nColumns in new but not in old: {paste(extra_cols, collapse=', ')}"))
  }

  if (length(missing_cols) == 0 && length(extra_cols) == 0) {
    message("\n✓ Column names match perfectly!")
  }

  # Compare unique drugs
  old_drugs <- sort(unique(old_pheno.df$drug))
  new_drugs <- sort(unique(new_pheno.df$drug))

  missing_drugs <- setdiff(old_drugs, new_drugs)
  extra_drugs <- setdiff(new_drugs, old_drugs)

  if (length(missing_drugs) > 0) {
    message(glue::glue("\nDrugs in old but not in new: {paste(missing_drugs, collapse=', ')}"))
  }

  if (length(extra_drugs) > 0) {
    message(glue::glue("\nDrugs in new but not in old: {paste(extra_drugs, collapse=', ')}"))
  }

  if (length(missing_drugs) == 0 && length(extra_drugs) == 0) {
    message("\n✓ Drug lists match perfectly!")
  }

  # Compare unique strains
  message(glue::glue("\nOld version strains: {length(unique(old_pheno.df$strain))}"))
  message(glue::glue("New version strains: {length(unique(new_pheno.df$strain))}"))
} else {
  message(glue::glue("\nOld version not found at {old_pheno_path}, skipping comparison"))
}
``` -->
</section>
</section>
     </main>
<!-- /main column -->  <script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>  </div> <!-- /content --> 
  
</body></html>