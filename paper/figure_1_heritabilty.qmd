---
execute:
  echo: false
  warning: false
  message: false
---

```{r}
#| include: false

library(dplyr)
library(ggplot2)
library(ggh4x)
library(ggrepel)
library(here)

# Source the portable project setup function
script_dir <- tryCatch(
  dirname(normalizePath(knitr::current_input())),
  error = function(e) getwd()
)

# Try multiple possible locations for the setup file
setup_file_paths <- c(
  file.path(script_dir, "..", "bin", "setup_project_here.R"), # Standard location relative to script
  file.path(getwd(), "bin", "setup_project_here.R"), # If we're in project root
  file.path(getwd(), "projects", "ToxinGWAS_Manuscript", "bin", "setup_project_here.R") # If in projects structure
)

setup_file <- NULL
for (path in setup_file_paths) {
  if (file.exists(path)) {
    setup_file <- path
    break
  }
}

if (!is.null(setup_file)) {
  source(setup_file)
  project_root <- setup_toxin_project_here()
} else {
  stop(
    "Could not find setup_project_here.R in any of the expected locations: ",
    paste(setup_file_paths, collapse = ", ")
  )
}

if (is.null(project_root)) {
  stop("Could not locate ToxinGWAS_Manuscript project root.")
}

```

```{r}
#| include: false
# Inputs
source(file.path(project_root, "bin", "tox_colors.R"))
source(file.path(project_root, "bin", "outs.R"))
source(file.path(project_root, "bin", "materials_key.R"))

#### Inputs ####

# load H2 and h2 rdata files
load(file.path(project_root, "data/processed/heritability/h2.list.mean.rda"))

# load the H2 data from boots
load(file.path(project_root, "data/processed/heritability/H2.parametric.boot.list.10000.rda"))

# load the tox data
tox <- data.table::fread(file.path(project_root, "data/processed/tox_data/con_metadata.csv")) %>%
  dplyr::filter(type == "Toxicant")

```

```{r}
#| include: false

#### Create dataframes for plotting ####

## H2 ##

# setup as data frame
H2.df.list <- NULL
for (i in 1:length(H2.list)) {
  drug <- names(H2.list)[i]
  o <- H2.list[[i]][[1]] %>%
    dplyr::mutate(drug = drug)

  H2.df.list[[i]] <- o
}
# bind list
H2.df <- data.table::rbindlist(H2.df.list) %>%
  dplyr::filter(drug %in% unique(tox$drug))

## h2 ##

h2.df.list.b <- NULL
for (i in 1:length(h2.list.mean)) {
  drug <- names(h2.list.mean)[i]
  o <- h2.list.mean[[i]] %>%
    dplyr::mutate(drug = drug)

  h2.df.list.b[[i]] <- o
}
# bind list
h2.df.b <- data.table::rbindlist(h2.df.list.b)

# shape data to join
# join the H2 and h2 data
h.b2 <- dplyr::left_join(H2.df, h2.df.b) %>%
  dplyr::left_join(tox) %>%
  # dplyr::filter(big_class != "Flame Retardant") %>%
  dplyr::mutate(nice_drug_label2 = stringr::str_replace(nice_drug_label2, pattern = "uM", replacement = "ÂµM"))


# make nice colors for class
# class colors for y
man_pal2 <- h.b2 %>%
  dplyr::distinct(big_class) %>%
  dplyr::arrange(big_class) %>%
  dplyr::left_join(class.pal.df) %>%
  dplyr::pull(col)

# set strip col for y
strip2 <- ggh4x::strip_themed(background_x = ggh4x::elem_list_rect(fill = man_pal2))
labels2 <- c(
  "Flame Retardant" = "Flame Retardants",
  "Fungicide" = "Fungicides",
  "Herbicide" = "Herbicides",
  "Insecticide" = "Insecticides",
  "Metal" = "Metals"
)
# plot it
heritability_all_classes_p <- ggplot(h.b2, aes(x = H2.point, y = h2.point)) +
  geom_point() +
  geom_pointrange(aes(ymin = h2.lower, ymax = h2.upper), size = 0.5, alpha = 0.2) +
  geom_pointrange(aes(xmin = H2.CI.lower, xmax = H2.CI.upper), size = 0.5, alpha = 0.2) +
  ggrepel::geom_text_repel(aes(label = nice_drug_label2), size = 2.25) +
  theme_bw() +
  geom_abline(
    color = "grey",
    alpha = 0.5,
    slope = 1,
    intercept = 0,
    linetype = 2
  ) +
  ggh4x::facet_wrap2(~big_class, strip = strip2, labeller = as_labeller(labels2)) +
  ggplot2::labs(
    x = expression(bold("Broad-sense heritability") ~ bolditalic(H)^{
      2
    }),
    y = expression(bold("Narrow-sense heritability") ~ bolditalic(h)^{
      2
    })
  ) +
  ggplot2::theme(
    legend.position = "none",
    panel.grid = element_blank(),
    strip.text.y = element_text(
      size = 10,
      # family = "Arial",
      face = "bold"
    ),
    strip.text.x = element_text(
      size = 10,
      # family = "Arial",
      face = "bold"
    ),
    axis.text = element_text(
      size = 10,
      # family = "Arial"
    ),
    axis.title = element_text(
      size = 10
    )
  ) +
  ggplot2::scale_x_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2)) +
  ggplot2::scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.2))

# save the manuscript version
save_plot(
  heritability_all_classes_p,
  figure_fns$heritability_all_classes,
  w_in = 7.5,
  h_in = 5
)

```

```{r}
#| label: fig-heritability
#| fig-width: 7.5
#| fig-height: 5
#| fig-cap: "**Heritability of toxicant susceptibilities**. The broad-sense (H2) (x-axis) and narrow-sense heritability (h2) (y-axis) of normalized animal length measurements were calculated for each toxicant exposure condition. Within each use group, heritability estimates for a single toxicant exposure condition are denoted by a cross, where the horizontal line corresponds to the 95% confidence interval of the broad-sense heritability estimate obtained using the parametric bootstrapping approach, and the vertical line corresponds to the standard error of the narrow-sense heritability estimate. The three toxicants measured at two concentrations (TPhP, paraquat, and silver) are annotated with concentrations."
heritability_all_classes_p
```
