---
execute:
  echo: false
  warning: false
  message: false
---

```{r}
#| include: false
library(tidyverse)
library(pheatmap)
library(cowplot)
library(glue)
library(here)
```

```{r}
# Source the portable project setup function
script_dir <- tryCatch(
  dirname(normalizePath(knitr::current_input())),
  error = function(e) getwd()
)

# Try multiple possible locations for the setup file
setup_file_paths <- c(
  file.path(script_dir, "..", "bin", "setup_project_here.R"), # Standard location relative to script
  file.path(getwd(), "bin", "setup_project_here.R"), # If we're in project root
  file.path(getwd(), "projects", "ToxinGWAS_Manuscript", "bin", "setup_project_here.R") # If in projects structure
)

setup_file <- NULL
for (path in setup_file_paths) {
  if (file.exists(path)) {
    setup_file <- path
    break
  }
}

if (!is.null(setup_file)) {
  source(setup_file)
  project_root <- setup_toxin_project_here()
} else {
  stop(
    "Could not find setup_project_here.R in any of the expected locations: ",
    paste(setup_file_paths, collapse = ", ")
  )
}

if (is.null(project_root)) {
  stop("Could not locate ToxinGWAS_Manuscript project root.")
}

```

```{r}
#| include: false
# Load correlation data
pheno_corr_all <- readRDS(file.path(project_root, "data/processed/phenotypes/pheno_corr_all.Rds"))
tox_data <- data.table::fread(file.path(project_root, "data/processed/tox_data/con_metadata.csv"))
```


```{r}
#| include: false
# Create the color palette and annotation data


# Set color palette for annotations
class.pal.df <- tibble::tibble(
  col = c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#D55E00"),
  big_class = c("Control", "Flame Retardant", "Fungicide", "Herbicide", "Insecticide", "Metal")
)

# filter the meta data to include only toxicant and join to the class palette
tox_cols <- tox_data %>%
  # remove the controls
  dplyr::filter(big_class != "Control") %>%
  dplyr::select(drug, nice_drug_label2, big_class, moa_class) %>%
  # Clean up to have special character for plotting
  dplyr::mutate(nice_drug_label2 = stringr::str_replace(nice_drug_label2, pattern = "uM", replacement = "µM")) %>%
  # join to the class palette
  dplyr::left_join(., class.pal.df, by = c("big_class" = "big_class")) %>%
  dplyr::select(drug, nice_drug_label2, big_class, moa_class, col)

# Create a mapping from drug to nice_drug_label2
drug_to_label <- setNames(tox_cols$nice_drug_label2, tox_cols$drug)

# Get correlation coefficients and p-values
pheno_corr_all_r <- pheno_corr_all$r
pheno_corr_all_p <- pheno_corr_all$p
pheno_corr_all_p_symbol <- ifelse(round(pheno_corr_all$p, digits = 3) <= 0.05, "*", " ")

# Update row and column names of correlation matrices
rownames(pheno_corr_all_r) <- drug_to_label[rownames(pheno_corr_all_r)]
colnames(pheno_corr_all_r) <- drug_to_label[colnames(pheno_corr_all_r)]
rownames(pheno_corr_all_p_symbol) <- drug_to_label[rownames(pheno_corr_all_p_symbol)]
colnames(pheno_corr_all_p_symbol) <- drug_to_label[colnames(pheno_corr_all_p_symbol)]

moa_anno_df <- tox_cols %>%
  # set the row names to the nice drug label
  tibble::column_to_rownames(var = "nice_drug_label2") %>%
  # rename the big class column to Class
  dplyr::rename(Class = big_class) %>%
  # remove the drug and color columns
  dplyr::select(-drug, -col)



# Create annotation colors
cols <- unique(class.pal.df$col)
names(cols) <- unique(class.pal.df$big_class)
anno_cols <- list(Class = cols)
```

```{r}
#| include: false
create_phenotype_heatmap <- function(similarity_matrix, con_metadata_df, anno_cols) {
  # Perform hierarchical clustering on rows to get the dendrogram
  row_dist <- dist(similarity_matrix)
  row_hclust <- hclust(row_dist)

  # Use the same clustering order for both rows and columns
  # (since it's a symmetric similarity matrix)
  p <- pheatmap::pheatmap(
    similarity_matrix,
    annotation_row = con_metadata_df,
    annotation_colors = anno_cols,
    width = 7.5,
    height = 6,
    color = colorRampPalette(c("navy", "white", "darkred"))(1000),
    breaks = seq(-1, 1, length.out = (1000 + 1)),
    show_colnames = TRUE,
    fontsize_number = 12,
    display_numbers = pheno_corr_all_p_symbol,
    cluster_rows = row_hclust,
    silent = TRUE
  )
  return(p)
}
```

```{r}
#| label: fig-phenotype-correlations
#| fig-width: 7.5
#| fig-height: 6
#| fig-cap: Correlations between differences in susceptibility to toxicant conditions. The pairwise Spearman correlation coefficient (ρ) between all toxicant conditions is displayed as a heatmap. Spearman’s rank order correlation coefficients (colored cells), were calculated using the normalized animal length measurements for all strains. Significant correlations (p-value ≤ 0.05) are denoted with an asterisk (*). The top triangle shows significance symbols after Bonferroni multiple testing correction, and the bottom triangle shows uncorrected significance symbols. On the left, columns of colored tiles denote the mechanism of action (MoA) and class of each toxicant. The traits are arranged by hierarchical clustering performed with correlation coefficients. More similar toxicant conditions are grouped together. The similarity between toxicants is represented by the branch lengths in the dendrograms plotted to the left of the heatmap.
phenotype_correlations <- create_phenotype_heatmap(
  similarity_matrix = pheno_corr_all_r,
  con_metadata_df = moa_anno_df,
  anno_cols = anno_cols
)
phenotype_correlations
```

