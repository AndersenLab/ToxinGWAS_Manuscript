---
title: "Figure S3: Strain responses"
format: html
---

```{r}

outlier_status_hist_df <- strain_means_anno %>%
  dplyr::filter(HighResponder == 1 | LowResponder == 1) %>%
  dplyr::group_by(strain, drug) %>%
  dplyr::summarise(
    n_LowResponder = sum(LowResponder),
    n_HighResponder = sum(HighResponder),
    n_outliers = n_LowResponder + n_HighResponder
  )

# check if in the same drug a strain ever gets both designations
conflicting_strains <- outlier_status_hist_df %>%
  dplyr::filter(n_HighResponder == 1 & n_LowResponder == 1)

if (nrow(conflicting_strains) > 0) {
  stop("Error: Found strains that are both high and low responders. This should not happen.")
}

# generate a dataframe summarizing the number of times a strain is designated as
# an outlier of each type
outlier_summary_df <- outlier_status_hist_df %>%
  dplyr::group_by(strain) %>%
  dplyr::summarise(
    n_HighResponder = sum(n_HighResponder),
    n_LowResponder = sum(n_LowResponder)
  ) %>%
  tidyr::pivot_longer(
    cols = c(n_HighResponder, n_LowResponder),
    names_to = "Outlier_Type",
    values_to = "Count"
  ) %>%
  # remove any rows where strain did not rec. designation
  dplyr::filter(
    Count > 0
  )


## plot the histogram of the number of times a strain is designated an outlier ## ----------------------------

n_outlier_hist <- outlier_summary_df %>%
  ggplot2::ggplot(
    aes(
      x = Count,
      fill = Outlier_Type,
      group = Outlier_Type
    )
  ) +
  ggplot2::geom_histogram(
    binwidth = 1,
    position = "dodge",
    color = "black"
  ) +
  ggplot2::scale_fill_manual(
    values = c("n_HighResponder" = "red", "n_LowResponder" = "blue"),
    labels = c("n_HighResponder" = "Highly susceptible", "n_LowResponder" = "Minimally susceptible")
  ) +
  ggplot2::labs(
    x = "Number of conditions with same susceptibility",
    y = "Strains",
    fill = "Susceptibility"
  ) +
  ggplot2::theme_bw() +
  ggplot2::theme(
    # remove internal grid lines
    panel.grid = ggplot2::element_blank(),
    legend.position = "inside",
    legend.position.inside = c(0.85, 0.90),
    text = element_text(size = 10, family = "Arial"),
    legend.title = element_text(face = "bold"),
    axis.title.x = element_text(face = "bold"),
    axis.title.y = element_text(face = "bold")
  ) +
  ggplot2::scale_x_continuous(breaks = 1:max(outlier_summary_df$Count))

# Save the strain means plot as supplementary figure 2
save_plot(
  n_outlier_hist,
  sup_figure_fns$n_outlier_hist,
  w_in = 7.5, h_in = 7.5
)


```