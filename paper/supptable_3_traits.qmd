---
title: "Supplementary Table S3: Trait Data"
---

# Setup
```{r}
#| label: setup

library(data.table)
library(dplyr)
library(flextable)
library(glue)

source("bin/outs.R")
source("bin/materials_key.R")
```

# Overview

This script generates Supplementary Table S3, which contains the trait data for all strains across all toxicants. The column names are formatted with nice labels from the toxicant metadata.

# Inputs

```{r}
#| label: inputs

# Path to aggregated traits file (generated by trait_generate_mapping_inputs.qmd)
traits_fn <- "data/processed/aggregated_toxicant_traits.tsv"

# Path to toxicant metadata
tox_metadata_fn <- "data/processed/tox_data/tox_metadata.csv"
```

# Load data

```{r}
#| label: load-data

# Load the aggregated traits
traits_df <- data.table::fread(traits_fn)

# Load toxicant metadata
tox_metadata <- data.table::fread(tox_metadata_fn)

print(glue::glue("Loaded traits data: {nrow(traits_df)} strains Ã— {ncol(traits_df)} columns"))
print(glue::glue("Loaded metadata for {nrow(tox_metadata)} toxicant conditions"))
```

# Rename columns with nice labels

```{r}
#| label: rename-columns

# Create a mapping from trait column names to nice labels
# Extract trait -> nice_drug_label2 mapping
trait_label_map <- tox_metadata %>%
  dplyr::select(trait, nice_drug_label2) %>%
  dplyr::distinct()

# Create a named vector for easy renaming
rename_vector <- setNames(trait_label_map$nice_drug_label2, trait_label_map$trait)

# Keep strain column, rename trait columns
traits_renamed <- traits_df %>%
  dplyr::rename(Strain = strain)

# Rename the trait columns
for (old_name in names(rename_vector)) {
  if (old_name %in% names(traits_renamed)) {
    new_name <- rename_vector[[old_name]]
    names(traits_renamed)[names(traits_renamed) == old_name] <- new_name
  }
}

print(glue::glue("Renamed columns:"))
print(names(traits_renamed))
```

# Create flextable

```{r}
#| label: create-flextable

# Create the flextable
trait_ft <- flextable::flextable(traits_renamed) %>%
  flextable::theme_apa() %>%
  flextable::fontsize(size = 9, part = "all") %>%
  flextable::align(align = "center", part = "all") %>%
  flextable::align(j = 1, align = "left", part = "all") %>%
  flextable::bold(part = "header") %>%
  flextable::set_caption(
    caption = "Supplementary Table S3. Toxicant response trait values for all C. elegans strains. Values represent normalized phenotype measurements (length) for each strain under each toxicant condition."
  ) %>%
  flextable::autofit()

print("Flextable created successfully")
```

# Save table

```{r}
#| label: save-table

# Save the flextable using the standardized naming from materials_key.R
save_supp_table_flextable(
  flex_table = trait_ft,
  table_name = "trait_table"
)

# Also save as CSV for easy access
save_supp_table_csv(
  data = traits_renamed,
  table_name = "trait_table"
)

print(glue::glue("Saved Supplementary Table S3 to:"))
print(glue::glue("  {table_fns$trait_table$docx}"))
print(glue::glue("  {table_fns$trait_table$html}"))
print(glue::glue("  {table_fns$trait_table$csv}"))
```

# Preview table

```{r}
#| label: preview-table

# Display the first few rows
print(trait_ft)
```
