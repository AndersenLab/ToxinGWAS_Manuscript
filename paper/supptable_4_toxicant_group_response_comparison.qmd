---
title: "Table S4: Toxicant group comparison"
format: html
execute: 
  echo: false
---

```{r}
#| label: toxicant-group-response-comparison-project-setup
#| include: false

library(tidyverse)
library(flextable)
library(here)

# Source the portable project setup function
script_dir <- tryCatch(
  dirname(normalizePath(knitr::current_input())),
  error = function(e) getwd()
)

# Try multiple possible locations for the setup file
setup_file_paths <- c(
  file.path(script_dir, "..", "bin", "setup_project_here.R"), # Standard location relative to script
  file.path(getwd(), "bin", "setup_project_here.R"), # If we're in project root
  file.path(getwd(), "projects", "ToxinGWAS_Manuscript", "bin", "setup_project_here.R") # If in projects structure
)

setup_file <- NULL
for (path in setup_file_paths) {
  if (file.exists(path)) {
    setup_file <- path
    break
  }
}

if (!is.null(setup_file)) {
  source(setup_file)
  project_root <- setup_toxin_project_here()
} else {
  stop(
    "Could not find setup_project_here.R in any of the expected locations: ",
    paste(setup_file_paths, collapse = ", ")
  )
}

if (is.null(project_root)) {
  stop("Could not locate ToxinGWAS_Manuscript project root.")
}
```

```{r}
#| label: toxicant-group-response-comparison-input
#| include: false

# Load required data
drug_means <- readRDS(file.path(project_root, "data/processed/phenotypes/drug_means.rds"))

# Source the output functions
source(file.path(project_root, "bin/outs.R"))
source(file.path(project_root, "bin/materials_key.R"))
```


```{r}
#| label: toxicant-group-response-comparison-calculations
#| include: false

# Calculate summary statistics for both Use and MoA groups
use_group_summary <- drug_means %>%
  dplyr::group_by(group = big_class) %>%
  dplyr::summarise(
    group_type = "Use",
    avg_sd = mean(sd_NormLength),
    sd_avg_sd = sd(sd_NormLength)
  )


# Calculate summary statistics for both Use and MoA groups
use_group_summary <- drug_means %>%
  dplyr::group_by(group = big_class) %>%
  dplyr::summarise(
    group_type = "Use",
    avg_sd = mean(sd_NormLength),
    sd_avg_sd = sd(sd_NormLength)
  )

moa_group_summary <- drug_means %>%
  dplyr::group_by(group = moa_class) %>%
  dplyr::summarise(
    group_type = "MoA",
    avg_sd = mean(sd_NormLength),
    sd_avg_sd = sd(sd_NormLength)
  )

# Combine the summaries
group_summary <- dplyr::bind_rows(use_group_summary, moa_group_summary) %>%
  dplyr::arrange(group_type, desc(avg_sd))
```

```{r}
#| label: tbl-toxicant-group-response-comparison
#| echo: false
group_summary
```

```{r}
# Create grouped data
grouped_data <- as_grouped_data(
  x = group_summary,
  groups = "group_type"
)

# Create flextable from grouped data
group_pheno_ft <- as_flextable(
  grouped_data,
  col_keys = c(
    "group",
    "avg_sd",
    "sd_avg_sd"
  ),
  hide_grouplabel = TRUE
) %>%
  flextable::set_header_labels(
    values = list(
      "group" = "Group",
      "avg_sd" = "Average SD"
    )
  ) %>%
  # Combine avg_sd and sd_avg_sd using mk_par
  flextable::compose(
    j = "avg_sd",
    # but not for the group rows
    i = ~ !is.na(group),
    value = as_paragraph(
      sprintf("%.3f", avg_sd),
      " Â± ",
      sprintf("%.3f", sd_avg_sd)
    )
  ) %>%
  # Delete the sd_avg_sd column since it's now combined
  flextable::delete_columns("sd_avg_sd") %>%
  # make only the groups and header bold
  flextable::bold(
    j = 1,
    i = ~ is.na(group),
    bold = TRUE,
    part = "body"
  ) %>%
  flextable::bold(part = "header") %>%
  flextable::line_spacing(space = 1, part = "all") %>%
  flextable::align(j = 1, align = "center") %>%
  flextable::align(j = 2, align = "center") %>%
  flextable::hline(
    i = ~ is.na(group),
    part = "body"
  ) %>%
  flextable::set_table_properties(
    layout = "autofit",
    width = 1,
    opts_word = list(
      split = FALSE,
      keep_with_next = TRUE
    )
  )

# # Save the table using standardized functions
# save_supp_table_csv(group_summary, "group_summary")
# save_supp_table_flextable(group_pheno_ft, "group_summary")
```