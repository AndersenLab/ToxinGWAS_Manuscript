---
title: "Table S6. Heritability estimates for toxicant conditions"
format: html
---

```{r}
library(dplyr)
library(data.table)
library(flextable)
```

```{r}
#| include: false

# load the functions to save the output
source("bin/outs.R")
source("bin/materials_key.R")
```

# Inputs 
```{r}
# load H2 and h2 rdata files
load("data/processed/heritability/h2.list.mean.rda")

# load the H2 data from boots
load("data/processed/heritability/H2.parametric.boot.list.10000.rda")

# load the tox data
tox <- data.table::fread("data/processed/tox_data/con_metadata.csv") %>%
  dplyr::filter(type == "Toxicant")
```

# Main

```{r}
## H2 ##
# setup as data frame
H2.df.list <- NULL
for (i in 1:length(H2.list)) {
  drug <- names(H2.list)[i]
  o <- H2.list[[i]][[1]] %>%
    dplyr::mutate(drug = drug)

  H2.df.list[[i]] <- o
}
# bind list
H2.df <- data.table::rbindlist(H2.df.list) %>%
  dplyr::filter(drug %in% unique(tox$drug))

## h2 ##

h2.df.list.b <- NULL
for (i in 1:length(h2.list.mean)) {
  drug <- names(h2.list.mean)[i]
  o <- h2.list.mean[[i]] %>%
    dplyr::mutate(drug = drug)

  h2.df.list.b[[i]] <- o
}
# bind list
h2.df.b <- data.table::rbindlist(h2.df.list.b)

h.b2 <- dplyr::left_join(H2.df, h2.df.b) %>%
  dplyr::left_join(tox) %>%
  # dplyr::filter(big_class != "Flame Retardant") %>%
  dplyr::mutate(nice_drug_label2 = stringr::str_replace(nice_drug_label2, pattern = "uM", replacement = "µM"))
```

```{r}
# Clean up the summary data for the supplement
h2_summary_clean <- h.b2 %>%
  dplyr::select(
    nice_drug_label2,
    big_class,
    H2.point,
    H2.CI.lower,
    H2.CI.upper,
    H2.CI.level,
    h2.point,
    h2.lower,
    h2.upper
  ) %>%
  rename(
    "Toxicant" = nice_drug_label2,
    "Class" = big_class,
    "Broad-sense heritability" = H2.point,
    "Broad-sense heritability CI lower" = H2.CI.lower,
    "Broad-sense heritability CI upper" = H2.CI.upper,
    "Broad-sense heritability CI level" = H2.CI.level,
    "Narrow-sense heritability" = h2.point,
    "Narrow-sense heritability CI lower" = h2.lower,
    "Narrow-sense heritability CI upper" = h2.upper
  ) %>%
  dplyr::group_by(Class) %>%
  dplyr::arrange(Class, `Broad-sense heritability`)
```

```{r}
# Calculate group means
group_means <- h2_summary_clean %>%
  dplyr::summarise(
    Toxicant = "Group Mean",
    `Broad-sense heritability` = mean(`Broad-sense heritability`),
    `Broad-sense heritability CI lower` = mean(`Broad-sense heritability CI lower`),
    `Broad-sense heritability CI upper` = mean(`Broad-sense heritability CI upper`),
    `Narrow-sense heritability` = mean(`Narrow-sense heritability`),
    `Narrow-sense heritability CI lower` = mean(`Narrow-sense heritability CI lower`),
    `Narrow-sense heritability CI upper` = mean(`Narrow-sense heritability CI upper`)
  )

# Combine individual and group mean data
h2_summary_with_means <- dplyr::bind_rows(
  h2_summary_clean,
  group_means
) %>%
  dplyr::arrange(Class, Toxicant == "Group Mean", `Broad-sense heritability`)

# Create grouped data by Class
grouped_data <- as_grouped_data(
  x = h2_summary_with_means,
  groups = "Class"
)
```

```{r}
# Create flextable from grouped data
heritability_ft <- as_flextable(
  grouped_data,
  col_keys = c(
    "Toxicant",
    "Broad-sense heritability",
    "Narrow-sense heritability"
  ),
  hide_grouplabel = TRUE
) %>%
  flextable::set_header_labels(
    values = list(
      "Toxicant" = "Toxicant",
      "Broad-sense heritability" = "Broad-sense heritability (H²)",
      "Narrow-sense heritability" = "Narrow-sense heritability (h²)"
    )
  ) %>%
  # Combine heritability values with their CIs
  flextable::compose(
    j = "Broad-sense heritability",
    i = ~ !is.na(Toxicant),
    value = as_paragraph(
      sprintf("%.3f", `Broad-sense heritability`),
      " [",
      sprintf("%.3f", `Broad-sense heritability CI lower`),
      ", ",
      sprintf("%.3f", `Broad-sense heritability CI upper`),
      "]"
    )
  ) %>%
  flextable::compose(
    j = "Narrow-sense heritability",
    i = ~ !is.na(Toxicant),
    value = as_paragraph(
      sprintf("%.3f", `Narrow-sense heritability`),
      " [",
      sprintf("%.3f", `Narrow-sense heritability CI lower`),
      ", ",
      sprintf("%.3f", `Narrow-sense heritability CI upper`),
      "]"
    )
  ) %>%
  # make only the groups and header bold
  flextable::bold(
    j = 1,
    i = ~ is.na(Toxicant) | Toxicant == "Group Mean",
    bold = TRUE,
    part = "body"
  ) %>%
  flextable::bold(part = "header") %>%
  flextable::line_spacing(space = 1, part = "all") %>%
  flextable::align(j = 1, align = "left") %>%
  flextable::align(j = 2:3, align = "center") %>%
  flextable::hline(
    i = ~ is.na(Toxicant) | Toxicant == "Group Mean",
    part = "body"
  ) %>%
  flextable::set_table_properties(
    layout = "autofit",
    width = 1,
    opts_word = list(
      split = FALSE,
      keep_with_next = TRUE
    )
  )
# Save the table using standardized functions
save_supp_table_csv(h2_summary_with_means, "heritability_summary")
save_supp_table_flextable(heritability_ft, "heritability_summary")
```

```{r}
heritability_ft
```