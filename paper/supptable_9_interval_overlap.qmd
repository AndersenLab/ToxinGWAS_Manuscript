---
title: "Table S9. Overlapping susceptibility-associated intervals across toxicant condition pairs"
---

```{r}
#| label: interval-overlap-setup
#| include: false

library(data.table)
library(dplyr)
library(flextable)

source("bin/outs.R")
source("bin/materials_key.R")
```
# Inputs
```{r}
#| label: interval-overlap-inputs
# toxicant condition metadata
tox_meta_fn <- "data/processed/tox_data/tox_metadata.csv"

# LD between peak markers from plink
inbred_qtl_overlap_peak_ld_fn <- "data/processed/interval_overlap/peak_ld_rsq.csv"

inbred_qtl_overlaps_fn <- "data/processed/interval_overlap/inbred_qtl_overlaps.csv"

# interval overlap summary output by `find_overlaps.R`
inbred_qtl_overlaps_summary_fn <- "data/processed/interval_overlap/inbred_qtl_overlaps_summary.csv"

```
# Main
Join the interval overlaps with LD between peak markers 
```{r}
#| label: interval-overlap-main
# load the toxicant condition metadata
tox_meta <- fread(tox_meta_fn)

# load the inbred qtl overlaps
inbred_qtl_overlaps <- data.table::fread(inbred_qtl_overlaps_fn)

# load the interval overlap summary
inbred_qtl_overlaps_summary <- data.table::fread(inbred_qtl_overlaps_summary_fn)

# load the LD between peak markers
inbred_qtl_overlap_peak_ld <- 
  data.table::fread(
    inbred_qtl_overlap_peak_ld_fn, 
    col.names = c( "peakidA", "peakidB", "R2")
  )%>%
  # format peakids to match those in the overlaps data instead of plink required format
  dplyr::mutate(
    peakidA = stringr::str_replace(peakidA, pattern = "_", replacement = ":"),
    peakidB = stringr::str_replace(peakidB, pattern = "_", replacement = ":") 
  )

# Create mapping from trait to nice_drug_label2
trait_to_nice_label <- setNames(tox_meta$nice_drug_label2, tox_meta$trait)

### Join the overlaps to the LD data ###
inbred_qtl_overlap_peak_w_ld <- inbred_qtl_overlaps_summary %>%
  # update the traitA and traitB columns to use the nice_drug_label2
  dplyr::mutate(
    traitA = trait_to_nice_label[traitA],
    traitB = trait_to_nice_label[traitB]
  ) %>%
  dplyr::left_join(inbred_qtl_overlap_peak_ld, by = c("peakidA", "peakidB"))

```
Create formatted flextable of the overlaps with LD
```{r}
#| label: interval-overlap-flextable

# restrict to the columns we want
overlap_pre <- inbred_qtl_overlap_peak_w_ld %>%
  dplyr::select(
    traitA,
    traitB,
    peakidA,
    peakidB,
    R2
  )

# create a column to combine traitA and traitB
overlap_pre <- overlap_pre %>%
  mutate(
    trait_pair = paste(traitA, traitB, sep = " & "),
    interval_pair = paste(peakidA, peakidB, sep = " & ")
  )

# create a grouped flextable
overlap_pre_group <- overlap_pre %>%
  dplyr::arrange(trait_pair, R2) %>%
  as_grouped_data(
    groups = c("trait_pair")
  )

# create a flextable
overlap_ft <- overlap_pre_group %>%
  flextable::as_flextable(
    col_keys = c("trait_pair", "interval_pair", "R2"),
    hide_grouplabel = TRUE
  ) %>%
  flextable::bold(part = "header") %>%
  # when R2 is NA make the row text bold
  flextable::bold(j = 1, i = ~ !is.na(trait_pair), bold = TRUE, part = "body") %>%
  flextable::set_header_labels(
    trait_pair = "Trait Pair",
    interval_pair = "Interval Pair",
    R2 = "LD (r²)"
    ) %>%
  flextable::set_table_properties(layout = "autofit") %>%
  flextable::align(align = "left", part = "all") %>%
  flextable::set_table_properties(
    layout = "autofit",
    width = 1,
    opts_word = list(
      split = FALSE,
      keep_with_next = TRUE
    )
  ) %>%
  flextable::paginate(
    group = "trait_pair",
    group_def = c("rle")
  )

overlap_ft
```
```{r}
# prepare the CSV output with nice column names
overlap_csv <- overlap_pre %>%
  dplyr::select(trait_pair, interval_pair, R2) %>%
  dplyr::rename(
    "Trait Pair" = trait_pair,
    "Interval Pair" = interval_pair,
    "LD (r²)" = R2
  )

# save the flextable using standardized naming
save_supp_table_flextable(overlap_ft, "overlap_ft")
save_supp_table_csv(overlap_csv, "overlap_ft")
```